import React, { useState, useRef, useEffect } from "react";
import { useParams, useNavigate, Navigate } from "react-router-dom";
import { useMusicSearch } from "../hooks/useMusicSearch";
import { getEmotionDescription } from "../utils/emotionAnalyzer";
import { handleApiResponse, safeJsonParse } from "../utils/apiUtils";

import LoadingSpinner from "../components/LoadingSpinner";

export default function ResultPage() {
  const { emotion } = useParams<{ emotion: string }>();
  const navigate = useNavigate();
  const [currentTrackIndex, setCurrentTrackIndex] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentAudio, setCurrentAudio] = useState<HTMLAudioElement | null>(
    null
  );
  const [showAllTracks, setShowAllTracks] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [isSelectingTodaySong, setIsSelectingTodaySong] = useState(false);
  const [todaySongSelected, setTodaySongSelected] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const { tracks, loading, error, searchTracks } = useMusicSearch(
    emotion || ""
  );


  const handleBack = () => {
    if (currentAudio) {
      currentAudio.pause();
      setCurrentAudio(null);
      setIsPlaying(false);
    }
    navigate("/");
  };

  const handlePlayPause = () => {
    const currentTrack = tracks[currentTrackIndex];
    if (!currentTrack?.previewUrl) {
      alert("Ïù¥ Ìä∏ÎûôÏùÄ ÎØ∏Î¶¨Îì£Í∏∞Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
      return;
    }

    if (isPlaying && currentAudio) {
      currentAudio.pause();
      setIsPlaying(false);
    } else {
      // Í∏∞Ï°¥ Ïò§ÎîîÏò§ Ï†ïÎ¶¨
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.removeEventListener("ended", handleAudioEnd);
      }

      // ÏÉà Ïò§ÎîîÏò§ ÏÉùÏÑ±
      const newAudio = new Audio(currentTrack.previewUrl);
      newAudio.addEventListener("ended", handleAudioEnd);
      newAudio.addEventListener("error", () => {
        alert("Ïò§ÎîîÏò§ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        setIsPlaying(false);
      });

      newAudio.play().catch(() => {
        alert("Ïò§ÎîîÏò§ Ïû¨ÏÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        setIsPlaying(false);
      });

      setCurrentAudio(newAudio);
      setIsPlaying(true);
    }
  };

  const handleAudioEnd = () => {
    setIsPlaying(false);
    setCurrentAudio(null);
  };

  const handleTrackClick = (index: number) => {
    // ÌòÑÏû¨ Ïû¨ÏÉùÏ§ëÏù∏ Ïò§ÎîîÏò§ Ï†ïÏßÄ
    if (currentAudio) {
      currentAudio.pause();
      setCurrentAudio(null);
      setIsPlaying(false);
    }
    setCurrentTrackIndex(index);
  };

  const handlePreviousTrack = () => {
    const newIndex = Math.max(0, currentTrackIndex - 1);
    if (newIndex !== currentTrackIndex) {
      // ÌòÑÏû¨ Ïò§ÎîîÏò§ Ï†ïÏßÄ
      if (currentAudio) {
        currentAudio.pause();
        setCurrentAudio(null);
        setIsPlaying(false);
      }
      setCurrentTrackIndex(newIndex);
      // ÏÉà Ìä∏Îûô ÏûêÎèô Ïû¨ÏÉù
      setTimeout(() => {
        playTrack(newIndex);
      }, 100);
    }
  };

  const handleNextTrack = () => {
    const newIndex = Math.min(tracks.length - 1, currentTrackIndex + 1);
    if (newIndex !== currentTrackIndex) {
      // ÌòÑÏû¨ Ïò§ÎîîÏò§ Ï†ïÏßÄ
      if (currentAudio) {
        currentAudio.pause();
        setCurrentAudio(null);
        setIsPlaying(false);
      }
      setCurrentTrackIndex(newIndex);
      // ÏÉà Ìä∏Îûô ÏûêÎèô Ïû¨ÏÉù
      setTimeout(() => {
        playTrack(newIndex);
      }, 100);
    }
  };

  const playTrack = (index: number) => {
    const track = tracks[index];
    if (!track?.previewUrl) {
      alert("Ïù¥ Ìä∏ÎûôÏùÄ ÎØ∏Î¶¨Îì£Í∏∞Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
      return;
    }

    // Í∏∞Ï°¥ Ïò§ÎîîÏò§ Ï†ïÎ¶¨
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.removeEventListener("ended", handleAudioEnd);
    }

    // ÏÉà Ïò§ÎîîÏò§ ÏÉùÏÑ±
    const newAudio = new Audio(track.previewUrl);
    newAudio.addEventListener("ended", handleAudioEnd);
    newAudio.addEventListener("error", () => {
      alert("Ïò§ÎîîÏò§ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
      setIsPlaying(false);
    });

    newAudio.play().catch(() => {
      alert("Ïò§ÎîîÏò§ Ïû¨ÏÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
      setIsPlaying(false);
    });

    setCurrentAudio(newAudio);
    setIsPlaying(true);
  };

  const handleSaveTrack = async () => {
    const currentTrack = tracks[currentTrackIndex];
    if (!currentTrack) return;

    setIsSaving(true);
    try {
      const response = await fetch("/api/music/recommendations", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          emotion: emotion,
          track_name: currentTrack.trackName,
          artist_name: currentTrack.artistName,
          album_name: currentTrack.collectionName,
          preview_url: currentTrack.previewUrl,
          artwork_url: currentTrack.artworkUrl100,
        }),
      });

      if (response.ok) {
        alert("Ìä∏ÎûôÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! üéµ");
      } else {
        if (response.status === 401) {
          const shouldLogin = window.confirm(
            "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
          );
          if (shouldLogin) {
            navigate("/auth");
          }
        } else {
          try {
            const errorData = await safeJsonParse(response);
            alert(errorData.error || "Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          } catch (parseError) {
            alert(`Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${response.status})`);
          }
        }
      }
    } catch (error) {
      console.error("Save error:", error);
      alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    } finally {
      setIsSaving(false);
    }
  };

  const handleSelectTodaySong = async () => {
    const currentTrack = tracks[currentTrackIndex];
    if (!currentTrack) return;

    setIsSelectingTodaySong(true);
    try {
      // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ (Ïòà: localStorage ÎòêÎäî ÏÑ∏ÏÖòÏóêÏÑú AI Î∂ÑÏÑù Í≤∞Í≥º Í∞ÄÏ†∏Ïò§Í∏∞)
      const analysisData = JSON.parse(
        sessionStorage.getItem("recentAnalysis") || "{}"
      );

      if (!analysisData.diaryContent || !analysisData.emotion) {
        alert("ÏùºÍ∏∞ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏùºÍ∏∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.");
        return;
      }

      const response = await fetch("/api/daily-entries", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          diary_content: analysisData.diaryContent,
          detected_emotion: emotion || analysisData.emotion,
          selected_track_name: currentTrack.trackName,
          selected_artist_name: currentTrack.artistName,
          selected_album_name: currentTrack.collectionName,
          selected_preview_url: currentTrack.previewUrl,
          selected_artwork_url: currentTrack.artworkUrl100,
          selected_track_view_url: currentTrack.trackViewUrl,
          ai_analysis: analysisData.analysis,
          ai_advice: analysisData.advice,
          ai_encouragement: analysisData.encouragement,
        }),
      });

      if (response.ok) {
        setTodaySongSelected(true);
        alert(
          "Ïò§ÎäòÏùò Í≥°Ïù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§! üéÜ\nÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Ïò§ÎäòÏùò ÏùºÍ∏∞ÏôÄ Ìï®Íªò ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§."
        );
        // ÏÑ∏ÏÖò Ï†ÄÏû•Îêú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
        sessionStorage.removeItem("recentAnalysis");
      } else {
        if (response.status === 401) {
          const shouldLogin = window.confirm(
            "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
          );
          if (shouldLogin) {
            navigate("/auth");
          }
        } else {
          try {
            const errorData = await safeJsonParse(response);
            alert(errorData.error || "Ïò§ÎäòÏùò Í≥° ÏÑ†ÌÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          } catch (parseError) {
            alert(`Ïò§ÎäòÏùò Í≥° ÏÑ†ÌÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${response.status})`);
          }
        }
      }
    } catch (error) {
      console.error("Today song selection error:", error);
      alert("Ïò§ÎäòÏùò Í≥° ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    } finally {
      setIsSelectingTodaySong(false);
    }
  };

  const handleOpenItunes = () => {
    const currentTrack = tracks[currentTrackIndex];
    if (currentTrack?.trackViewUrl) {
      window.open(currentTrack.trackViewUrl, "_blank");
    } else {
      alert("iTunes ÎßÅÌÅ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
    }
  };

  const handleGoToDashboard = () => {
    // ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ Ïò§ÎîîÏò§ Ï†ïÏßÄ
    if (currentAudio) {
      currentAudio.pause();
      setCurrentAudio(null);
      setIsPlaying(false);
    }
    navigate("/dashboard");
  };

  const handleShowMore = () => {
    setShowAllTracks(true);
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïò§ÎîîÏò§ Ï†ïÎ¶¨
  useEffect(() => {
    return () => {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.removeEventListener("ended", handleAudioEnd);
      }
    };
  }, [currentAudio]);

  if (!emotion) {
    return <Navigate to="/" replace />;
  }

  if (loading) {
    return <LoadingSpinner emotion={emotion} />;
  }

  if (error) {
    return (
      <div className="relative flex items-center justify-center min-h-screen p-8 overflow-hidden font-sans bg-gradient-to-br from-white via-blue-50/30 to-blue-100/50">
        <div className="w-full max-w-lg p-12 text-center modern-card">
          <div className="mb-8 text-6xl">‚ùå</div>
          <h2 className="mb-6 text-2xl font-semibold text-gray-900">
            Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§
          </h2>
          <p className="mb-8 text-gray-600">{error}</p>
          <button
            onClick={handleBack}
            className="px-8 py-3 font-medium soft-button rounded-xl"
          >
            Îã§Ïãú ÏãúÎèÑ
          </button>
        </div>
      </div>
    );
  }


  return (
    <div className="relative min-h-screen overflow-hidden font-sans bg-gradient-to-br from-white via-blue-50/30 to-blue-100/50">
      {/* Organic curved background elements */}
      <div className="absolute inset-0 opacity-10">
        <div className="absolute h-64 transform rounded-full top-20 left-20 w-96 bg-gradient-to-br from-blue-200 to-blue-300 rotate-12 blur-3xl"></div>
        <div className="absolute h-48 transform rounded-full bottom-20 right-20 w-72 bg-gradient-to-br from-blue-100 to-blue-200 -rotate-6 blur-2xl"></div>
        <div className="absolute w-64 h-40 transform rotate-45 rounded-full top-60 left-1/2 bg-gradient-to-br from-blue-300 to-blue-400 blur-3xl"></div>
      </div>

      {/* Main Layout Container */}
      <div className="px-8 py-12">
        <div className="mx-auto max-w-7xl">
          <div className="grid min-h-screen grid-cols-1 gap-12 lg:grid-cols-2">
            {/* Left Side - Music Player Section */}
            <div className="lg:sticky lg:top-24 lg:h-fit">
              <div className="p-8 mb-8 modern-card">
                {/* Currently Playing Track */}
                <div className="mb-8 text-center">
                  <div className="relative mx-auto mb-6 vinyl-record">
                    {tracks.length > 0 && (
                      <img
                        src={
                          tracks[currentTrackIndex]?.artworkUrl100?.replace(
                            "100x100",
                            "300x300"
                          ) || "/default-album.jpg"
                        }
                        alt={
                          tracks[currentTrackIndex]?.trackName ||
                          "Album artwork"
                        }
                        className="absolute inset-4 rounded-full object-cover w-[168px] h-[168px]"
                        onError={(e) => {
                          (e.target as HTMLImageElement).src =
                            "/default-album.jpg";
                        }}
                      />
                    )}
                  </div>

                  {tracks.length > 0 && (
                    <div>
                      <h2 className="mb-2 text-3xl font-bold text-gray-900">
                        {tracks[currentTrackIndex]?.trackName || "Addict"}
                      </h2>
                      <p className="mb-4 text-xl text-gray-600">
                        {tracks[currentTrackIndex]?.artistName || "Silva Hound"}
                      </p>

                      {/* Play Controls */}
                      <div className="flex items-center justify-center mb-6 space-x-4">
                        <button
                          onClick={handlePreviousTrack}
                          className="flex items-center justify-center w-12 h-12 transition-all rounded-full glass-effect hover:soft-glow disabled:opacity-50"
                          disabled={currentTrackIndex === 0}
                        >
                          ‚èÆÔ∏è
                        </button>
                        <button
                          onClick={handlePlayPause}
                          className="flex items-center justify-center w-16 h-16 text-2xl transition-transform rounded-full soft-button hover:scale-105"
                        >
                          {isPlaying ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è"}
                        </button>
                        <button
                          onClick={handleNextTrack}
                          className="flex items-center justify-center w-12 h-12 transition-all rounded-full glass-effect hover:soft-glow disabled:opacity-50"
                          disabled={currentTrackIndex === tracks.length - 1}
                        >
                          ‚è≠Ô∏è
                        </button>
                      </div>

                      {/* Save Option */}
                      <p className="mb-4 text-gray-600">
                        Ïù¥ Ìä∏ÎûôÏùÑ Ï†ÄÏû•ÌïòÏãúÍ≤†Ïñ¥Ïöî?
                      </p>
                      <div className="flex space-x-3">
                        <button
                          onClick={handleOpenItunes}
                          className="px-6 py-2 transition-transform rounded-full soft-button hover:scale-105"
                        >
                          üéµ iTunesÏóêÏÑú Î≥¥Í∏∞
                        </button>
                        <button
                          onClick={handleSaveTrack}
                          disabled={isSaving}
                          className="px-6 py-2 transition-transform rounded-full soft-button hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {isSaving ? "Ï†ÄÏû• Ï§ë..." : "üíæ Ï†ÄÏû•"}
                        </button>
                        <button
                          onClick={handleSelectTodaySong}
                          disabled={isSelectingTodaySong || todaySongSelected}
                          className="px-6 py-2 text-white transition-all rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {isSelectingTodaySong
                            ? "ÏÑ†ÌÉù Ï§ë..."
                            : todaySongSelected
                            ? "‚úì Ïò§ÎäòÏùò Í≥° ÏÑ†ÌÉùÎê®"
                            : "üåü Ïò§ÎäòÏùò Í≥°ÏúºÎ°ú ÏÑ†ÌÉù"}
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Emotion Info */}
              <div className="p-6 modern-card">
                <h3 className="mb-3 text-xl font-semibold text-gray-900">
                  Í∞êÏ†ï Î∂ÑÏÑù
                </h3>
                <div className="p-4 bg-gradient-to-r from-blue-100 to-blue-200 rounded-xl">
                  <p className="font-medium text-gray-800">"{emotion}"</p>
                  <p className="mt-2 text-sm text-gray-600">
                    {getEmotionDescription(emotion, "")}
                  </p>
                </div>
              </div>
            </div>

            {/* Right Side - Playlist Section */}
            <div>
              <div className="p-6 mb-8 modern-card">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-2xl font-bold text-gray-900">
                    Ï∂îÏ≤ú Ìä∏Îûô
                  </h2>
                </div>

                <div className="space-y-4">
                  {(showAllTracks ? tracks : tracks.slice(0, 4)).map(
                    (track, index) => (
                      <div
                        key={track.trackId}
                        className={`flex items-center space-x-4 p-3 rounded-xl hover:bg-white/50 transition-all cursor-pointer ${
                          index === currentTrackIndex
                            ? "bg-blue-50 border border-blue-200"
                            : ""
                        }`}
                        onClick={() => handleTrackClick(index)}
                      >
                        <img
                          src={track.artworkUrl100 || "/default-album.jpg"}
                          alt={track.trackName}
                          className="object-cover w-12 h-12 rounded-lg"
                          onError={(e) => {
                            (e.target as HTMLImageElement).src =
                              "/default-album.jpg";
                          }}
                        />
                        <div
                          className="flex-1"
                          onClick={() =>
                            window.open(track.trackViewUrl, "_blank")
                          }
                        >
                          <h4 className="font-medium text-gray-900 truncate transition-colors hover:text-blue-600">
                            {track.trackName}
                          </h4>
                          <p className="text-sm text-gray-600 truncate">
                            {track.artistName}
                          </p>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (track.previewUrl) {
                              const audio = new Audio(track.previewUrl);
                              audio
                                .play()
                                .catch(() =>
                                  alert("ÎØ∏Î¶¨Îì£Í∏∞Î•º Ïû¨ÏÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§.")
                                );
                            } else {
                              alert("Ïù¥ Ìä∏ÎûôÏùÄ ÎØ∏Î¶¨Îì£Í∏∞Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
                            }
                          }}
                          className="flex items-center justify-center w-8 h-8 transition-all rounded-full glass-effect hover:soft-glow"
                        >
                          ‚ñ∂Ô∏è
                        </button>
                      </div>
                    )
                  )}
                </div>

                {tracks.length > 4 && !showAllTracks && (
                  <div className="pt-4 mt-4 border-t border-gray-200">
                    <button
                      onClick={handleShowMore}
                      className="w-full py-2 text-sm font-medium text-center text-blue-600 transition-colors hover:text-blue-800"
                    >
                      +{tracks.length - 4} Í∞ú Îçî ÎßéÏùÄ Ìä∏Îûô Î≥¥Í∏∞
                    </button>
                  </div>
                )}
                {showAllTracks && (
                  <div className="pt-4 mt-4 border-t border-gray-200">
                    <button
                      onClick={() => setShowAllTracks(false)}
                      className="w-full py-2 text-sm font-medium text-center text-gray-600 transition-colors hover:text-gray-800"
                    >
                      Ï†ëÍ∏∞
                    </button>
                  </div>
                )}
              </div>

              {/* Action Buttons */}
              <div className="space-y-4">
                <button
                  onClick={() => {
                    // ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ Ïò§ÎîîÏò§ Ï†ïÏßÄ
                    if (currentAudio) {
                      currentAudio.pause();
                      setCurrentAudio(null);
                      setIsPlaying(false);
                    }
                    // Ìä∏Îûô Ïù∏Îç±Ïä§ Ï¥àÍ∏∞Ìôî Î∞è ÏÉà Ï∂îÏ≤ú Í∞ÄÏ†∏Ïò§Í∏∞
                    setCurrentTrackIndex(0);
                    setShowAllTracks(false);
                    searchTracks();
                  }}
                  className="w-full py-3 font-medium soft-button rounded-xl"
                >
                  üîÑ Îã§Î•∏ Ï∂îÏ≤úÍ∞ÄÏ†∏Ïò§Í∏∞
                </button>
                <button
                  onClick={() => navigate("/")}
                  className="w-full py-3 font-medium text-gray-700 transition-all glass-effect rounded-xl hover:soft-glow"
                >
                  ü§ñ ÏÉàÎ°úÏö¥ AI Î∂ÑÏÑù
                </button>
                <button
                  onClick={handleGoToDashboard}
                  className="w-full py-3 font-medium text-white transition-all bg-gradient-to-r from-sky-400 to-sky-500 rounded-xl hover:from-sky-500 hover:to-sky-600"
                >
                  üìä ÎåÄÏãúÎ≥¥Îìú Î≥¥Í∏∞
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
